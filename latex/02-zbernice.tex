\chapter{Vybrané zbernicové protokoly}
\label{kap:zbernice}

V tejto kapitole stručne spomenieme vybrané zbernicové protokoly a zhrnieme ich kľúčové vlastnosti, ktoré budú relevantné v ďalších častiach práce. Vo všeobecnosti existuje mnoho rôznych zbernicových protokolov. Tie môžu využívať rôzne techniky, ktoré umožňujú zabezpečiť komunikáciu a jej riadenie. Mnoho týchto protokolov má však veľa spoločných znakov. Aj preto sa v práci budeme venovať iba niektorým vybraným. V tejto kapitole najskôr uvedieme niektoré základné vlastnosti zberníc. Následne predstavíme 3 príklady zberníc (UART, SPI, I\textsuperscript{2}C), ktorých podporu implementujeme na FPGA MITM obvode popísanom v kapitole \ref{kap:implementacia}.

\section{Vlastnosti hardvérových zberníc}
V tejto časti spomenieme vybrané vlastnosti hardvérových zberníc a základnú kategorizáciu na základe týchto vlastností. Vlastnosti, ktoré opíšeme sú relevantné pre spôsob implementácie hardvérového MITM útoku na danej zbernici. Vlastnosti, ktoré nie sú relevantné, nebudeme popisovať.

\subsection{Synchrónne a asynchrónne zbernice}
Pre účel MITM útoku je veľmi dôležité rozlišovať medzi tzv. synchrónnymi a asynchrónnymi zbernicami. Synchrónne zbernice sa vyznačujú tým, že dátový signál je doplnený o synchronyzačný hodinový signál, ktorý riadi prenos dát na zbernici a umožňuje správne prečítať a dekódovať prenášané dáta. Takýto signál môže byť explicitne vysielaný na samostatnej linke, napr. zbernice SPI \cite{spiBus} a I\textsuperscript{2}C \cite{i2cSpec}.

Iný spôsob ako preniesť hodinový signál je zakódovať hodinový signál vrámci dátového. Prijímajúce zariadenie dokáže následne z prijatého signálu správne dekódovať synchronizované dáta. Tento spôsob synchrónneho prenosu dát sa využíva najmä pri vysokorýchlostných (angl. high-speed) sériových zberniciach \cite{serdes}, tzv. SerDes (Serializer-Deserializer), ako sú napríklad USB \cite{usbSpec} a PCIe \cite{pcieSpec}. Vysokorýchlostným zberniciam sa v práci nebudeme venovať, nakoľko si na fyzickej vrstve vyžadujú dedikovaný hardvér a vrámci FPGA obvodov sa zvyknú implementovať iba vyššie vrstvy daných protokolov.

Protikladom synchrónnych zberníc sú asynchrónne zbernice. Rozdiel spočíva v tom, že hodinový signál je implicitný a je daný parametrom protokolu, zvyčajne nazývaný symbolová rýchlosť (angl. baud rate). Symbolová rýchlosť určuje počet prenesených symbolov (napr. bitov) za sekundu. Príkladom takejto zbernice je UART \cite{uartBus}.

Z pohľadu MITM útoku nie je podstatné rozlišovať medzi asynchrónnymi zbernicami a synchrónnymi so zabudovaným hodinovým signálom. Ich spoločným znakom je, že nemáme explicitný hodinový signál, ktorý by riadil komunikáciu. To umožňuje v niektorých prípadoch odchytiť celý odvysielaný rámec, spracovať ho a následne odvysielať. V prípade synchrónnej zbernice s explicitným hodinovým signálom môže byť pozastavenie nemožné. Protokol danej zbernice určuje, ktorá strana má generovať riadiaci hodinový signál. V prípade, že hodinový signál generuje druhá strana, falošné dáta musíme vysielať synchrónne s týmto signálom. Tento problém úzko súvisí s tzv. master-slave architektúrou, ktorú popíšeme v ďalšej ćasti

\subsection{Architektúra master-slave}
Veľká časť protokolov hardvérových zberníc je postavená na asymetrickej master-slave architektúre. V master-slave architektúre protokol definuje (zvyčajne jedno) tzv. master zariadenie, ktoré riadi komunikáciu na zbernici. Príkladom riadenia komunikácie môže byť riadenie prístupu ku zbernici, vysielanie hodinového signálu v prípade synchrónnej zbernice a pod. Spôsob riadenia sa môže líšiť v závislosti od protokolu. Ostatné zariadenia, nazývané slave, sa musia riadeniu prispôsobiť. Okrem iného, to zvyčajne znamená, že môžu vysielať dáta len v časových intervaloch vyhradených master stranou. Príkladom master-slave zberníc sú SPI \cite{spiBus}, I\textsuperscript{2}C \cite{i2cSpec} a USB \cite{usbSpec}. Niektoré zbernice, napr. I\textsuperscript{2}C \cite{i2cSpec}, podporujú aj tzv. multi-master architektúru, ktorá umožňuje mať viacero master zariadení pripojených ku zbernici súčasne. Takýmto scenárom sa v práci nebudeme venovať, nakoľko ich využitie je pomerne zriedkavé.

Pre MITM útok prináša master-slave architektúra značné komplikácie. Najmä na master strane (rozhranie, na ktorom MITM zariadenie simuluje skutočné slave zariadenie) predstavuje principiálny problém fakt, že falošné dáta, ktoré chceme poslať musíme odvysielať vo vyhradených časových intervaloch určených mastrom. Toto obmedzenie je problematické v prípade ak falošné dáta závisia od dát vyslaných druhou stranou, ktoré sme ešte neprijali. V kapitole \ref{kap:implementacia} uvedieme čiastočné riešenie na tento problém. Asymetrickosť master-slave architektúry však znamená, že už na úrovni MITM logiky je potrebné poznať, ktorá strana je master a ktorá slave, čo principiálne znemožňuje úplne abstrahovať od tejto vlastnosti.

\subsection{Ďalšie vlastnosti zberníc}
Existuje aj mnoho ďalších vlastností, na základe ktorých môžeme zbernice kategorizovať. Tie nie sú až tak relevantné pre MITM útoky, no môžu ovplyvniť spôsob jeho implementácie, preto niektoré stručne spomenieme.

Na základe smeru komunikácie rozlišujeme medzi simplex, half-duplex a full-duplex zbernicami. Simplex zbernice umožňujú iba jednosmernú komunikáciu. Dnes sú pomerne zriedkavé, zvyknú sa však používať na zapojenie niektorých senzorov, ktoré podporujú iba jednosmernú komunikáciu. Príkladom simplex zbernice môže byť zbernica UART \cite{uartBus}, ktorá je štandardne full-duplex, ale umožňuje aj zapojenie v simplex režime. Half-duplex zbernice podporujú obojsmernú komunikáciu, jednotlivé strany však nemôžu vysielať súčasne. Príkladmi half-duplex zbernice sú I\textsuperscript{2}C \cite{i2cSpec} a 1-Wire \cite{1wireBus}. Full-duplex zbernice umožňujú komunikáciu oboma smermi súčasne, napr. UART \cite{uartBus} v štandardnom zapojení, USB \cite{usbSpec} a PCIe \cite{pcieSpec}.

Ďalej rozlišujeme medzi sériovými a paralelnými zbernicami. Sériové sa vyznačujú tým, že jednotlivé symboly sú prenášané sériovo, pričom niektoré zbernice, napr. PCIe \cite{pcieSpec}, podporujú sériový prenos viacerých rámcov súčasne po paralelných linkách. Paralelné zbernice naopak prenášajú samotný rámec paralelne po viacerých linkách.

Posledné dve kategórie, ktoré uvedieme sú point-to-point zbernice a multi-drop zbernice. Point-to-point zbernice sú určené pre zapojenie práve dvoch zariadení a sú následne dedikované pre prenos dát medzi týmito dvoma zariadeniami. Príkladmi point-to-point zberníc sú UART \cite{uartBus} a PCIe \cite{pcieSpec}. Multi-drop zbernice naopak podporujú zapojenie viacej ako dvoch zariadení súčasne. Následne je potom potrebné vrámci komunikácie jednoznačne určiť zariadenie, pre ktoré sú vysielané dáta určené. Najčastejším spôsobom je adresácia, napr. I\textsuperscript{2}C \cite{i2cSpec} a USB \cite{usbSpec}. Iný spôsob môže byť tzv. slave-select, označovaný aj chip-select, ktorý sa používa napríklad pri zbernici SPI \cite{spiBus}.

\section{UART zbernica}
UART (Universal Asynchronous Receiver Transmitter) je defakto-štandard, ktorý okrem hardvérového rozhrania definuje aj komunikačný protokol a niektoré jeho parametre. Z hľadiska kategorizácie ide o sériovú full-duplex asynchrónnu point-to-point linku. Keďže ide o point-to-point linku, riadenie prístupu nie je potrebné.

\subsection{Hardvér UART zbernice}
UART zbernica pozostáva z dvoch hlavných liniek: RX (Receive) pre prijímanie dát a TX (Transmit) pre vysielanie dát. Okrem týchto dátových existujú aj niektoré ďalšie riadiace linky, ktoré sú súčasťou RS-232 štandardu \cite{rs232Spec} (ktorý využíva UART protokol), tie sa však dnes zriedka využívajú, preto ich zanedbáme. Schéma zapojenia UART zbernice medzi dvoma zariadeniami je na obrázku \ref{obr:uartWiring}.

\begin{figure}
    \centerline{\includegraphics[width=0.9\textwidth]{images/uartWiring.png}}
    \caption[Zapojenie zbernice UART]{Zapojenie zbernice UART. Linky RX a TX sú zapojené do kríža.}
    \label{obr:uartWiring}
\end{figure}

\subsection{UART protokol a štruktúra rámcov}
UART definuje aj komunikačný protokol pre posielanie dát. V pasívnom stave je napätie danej linky na úrovni logickej 1 (zvyčajne 3.3\,V alebo 5\,V). Vysielaný rámec vždy začína bitom s logickou hodnotou 0, tzv. START bit. Nasledujú samotné dáta, ktorých dĺžka sa môže líšiť v závislosti od nastavených parametrov, najčastejšie 8 bitov. Za dátovými bitmi môže nasledovať nepovinný paritný bit, ten sa však zriedka využíva. Rámec je vždy ukončený tzv. STOP bitom s logickou hodnotou 1. Za STOP bitom môže nasledovať ľubovoľná pauza, ktorá sa v literatúre označuje aj predĺžený STOP bit. Štruktúra UART rámca je znázornená na obrázku \ref{obr:uartFrame}.

\begin{figure}
    \centerline{\includegraphics[width=1\textwidth]{images/uartFrame.png}}
    \caption[Štruktúra UART rámca]{Štruktúra UART rámca.}
    \label{obr:uartFrame}
\end{figure}

\section{SPI Zbernica}
Zbernica SPI je defakto-štandard, ktorý definuje hardvérové rozhranie, pre zapojenie komunikujúcich strán. SPI je synchrónna sériová zbernica typu multi-drop s explicitným hodinovým signálom na dedikovanej linke. Keďže ide o defakto-štandard, zbernica SPI nedefinuje predpísanú štruktúru posielaných dát \cite{spiBus}.

\subsection{Riadenie prístupu k zbernici}
Komunikácia na SPI zbernici je riadená master-slave architektúrou. Prístup k zbernici riadi master prostredníctvom dedikovanej linky SS (Slave Select) pre každé slave zariadenie. Linky SS zvyknú byť označené aj ako CS (Chip Select). V pasívnom stave je na každom SS vodiči logická hodnota 1. Pred začatím komunikácie s vybraným slave zariadením nastaví master logickú hodnotu 0 na príslušnom SS vodiči, čím umožní komunikáciu medzi master a príslušným slave zariadením. V niektorých implementáciách je polarita SS linky invertovaná. Tento spôsob riadenia zbernice vytvára ilúziu point-to-point linky medzi komunikujúcimi stranami, preto v zbernici SPI nie je potrebná adresácia.

\subsection{Hardvér SPI zbernice}
SPI zbernica pozostáva z troch hlavných liniek: MISO (Master In Slave Out), ktorá zabezpečuje prenos dát smerom od slave zariadení k master zariadeniu, MOSI (Master Out Slave In) pre prenos dát opačným smerom a SCLK (Serial Clock) pre prenos hodinového signálu (generovaný master zariadením) \cite{spiBus}. Schéma zapojenia pomocou SPI zbernice je na obrázku \ref{obr:spiWiring}. Dáta po vodičoch MISO a MOSI môžu tiecť súčasne čo umožňuje full-duplex komunikáciu.

\begin{figure}
    \centerline{\includegraphics[width=0.9\textwidth]{images/spiWiring.png}}
    \caption[Zapojenie zbernice SPI]{Zapojenie zbernice SPI.}
    \label{obr:spiWiring}
\end{figure}

\section{I\textsuperscript{2}C zbernica}
I\textsuperscript{2}C (Inter-Integrated Circuits) je štandardizovaná zbernica, vyvinutá spoločnosťou Philips Semiconductors, určená pre jednoduchú komunikáciu medzi integrovanými obvodmi \cite{i2cSpec} väčšinou v rámci jednej dosky plošných spojov. Podobne ako SPI, I\textsuperscript{2}C je synchrónna sériová zbernica typu multi-drop s dedikovaným hodinovým signálom. Narozdiel od UART a SPI zberníc I\textsuperscript{2}C podporuje iba half-duplex komunikáciu.

\subsection{Hardvér I\textsuperscript{2}C zbernice}
Zbernica pozostáva z dvoch vodičov: SDA (Serial Data Line), ktorý zabezpečuje sériový prenos dát (bitov) a SCL (Serial Clock Line) pre prenos synchronizačného hodinového signálu \cite{i2cSpec}. Vodiče sú na komunikujúcich zariadeniach pripojené v tzv. open-drain režime a (každé zvlášť) sú cez zdvíhací odpor (pull-up rezistor) pripojené k napätiu 5\,V resp. 3.3\,V v závislosti od konfigurácie. Na obrázku \ref{obr:i2cWiring} je znázornené zapojenie zariadení pomocou zbernice I\textsuperscript{2}C.

\begin{figure}
    \centerline{\includegraphics[width=0.9\textwidth]{images/i2cWiring.png}}
    \caption[Zapojenie zbernice I\textsuperscript{2}C]{Zapojenie zbernice I\textsuperscript{2}C. Open-drain logika interného zapojenia vodičov v zariadeniach je znázornená pomocou \uv{spínačov}. V skutočnosti je realizovaná pomocou tranzistorov.}
    \label{obr:i2cWiring}
\end{figure}

V pasívnom stave je teda na vodičoch hodnota napätia 5\,V (resp. 3.3\,V), čo na dátovej linke zodpovedá logickej hodnote 1. V prípade, že práve vysielajúce zaradenie chce poslať bit s logickou hodnotou 0, \uv{pripojí} (napr. pomocou tranzistora) vodič na spoločnú zem, čím napätie klesne na 0\,V. Dáta na vodiči SDA sú vzorkované pri nábehovej hrane na SCL signálovej linke \cite{i2cSpec}.

\subsection{Riadenie prístupu k zbernici}
Komunikácia na I\textsuperscript{2}C zbernici je riadená architektúrou master-slave \cite{i2cSpec}. Master zariadenie riadi komunikáciu na hardvérovej aj protokolovej úrovni. Na hardvérovej úrovni master zariadenie určuje rýchlosť komunikácie generovaním hodinových impulzov na SCL linke. Zbernica podporuje rôzne konfigurácie, ktoré sa líšia rýchlosťou rádovo od 100\,kbps až po niekoľko\,Mbps. Na protokolovej úrovni je každá komunikácia iniciovaná aj ukončená master zariadením a slave zariadenia musia synchrónne posielať dáta vo vyhradených časoch, ktoré definuje protokol.

Zariadenie, s ktorým chce master komunikovať je určené adresáciou. Každé slave zariadenie má pridelenú 7-bitovú (resp. 10-bitovú v novšej verzii štandardu) adresu, ktorá je zvyčajne pevne nastavená výrobcom hardvéru \cite{i2cSpec}. Z dôvodu predchádzania kolízií v adresách, zvyknú výrobcovia prideliť zariadeniu viacero adries, z ktorých je možne nakonfigurovať práve jednu, väčšinou hardvérovým spínačom.

\subsection{Protokol a štruktúra rámcov}
I\textsuperscript{2}C štandard striktne definuje spôsob komunikácie na zbernici. Samotná komunikácia vyzerá nasledovne: Master zariadenie nastaví úroveň napätia na SDA linke na hodnotu logickej 0, čím pošle tzv. START bit, ktorý signalizuje začiatok komunikácie. Nasleduje 7-bitová (resp. 10-bitová) adresa zariadenia, s ktorým chce master komunikovať a jeden tzv. R/W bit, ktorý označuje, či ide o operáciu čítania alebo zápisu. (Z pohľadu master zariadenia logická 1 predstavuje čítanie, 0 predstavuje zápis.) S nasledujúcim hodinovým impulzom musí adresované slave zariadenie komunikáciu potvrdiť (pošle tzv. ACK bit) tým, že úroveň napätia na SDA linke nastaví na hodnotu logickej 0. Potom nasledujú samotné dáta, ktoré posiela master (resp. slave v prípade, že ide o operáciu čítania). Dáta su členené na 8-bitové sekvencie, ktoré sú zakaždým potvrdzované druhou stranou rovnakým spôsobom. Za posledným potvrdením dát pošle master tvz. STOP bit, čím signalizuje ukončenie komunikácie. Štruktúra rámca je znázornená na obrázku \ref{obr:i2cFrame}.

\begin{figure}
    \centerline{\includegraphics[width=1\textwidth]{images/i2cFrame.png}}
    \caption[Štruktúra I\textsuperscript{2}C rámca]{Štruktúra I\textsuperscript{2}C rámca.}
    \label{obr:i2cFrame}
\end{figure}

V prípade, že počas komunikácie nastane chyba, prijímajúce zariadenie nepošle ACK bit. Teda napätie na SDA linke ostane na úrovni logickej 1 (tzv. NACK bit), čo je zároveň pasívny stav. V takomto prípade môže master reagovať dvoma spôsobmi. Buď pošle STOP bit, čo znamená okamžité ukončenie komunikácie, alebo môže zopakovať komunikáciu od začiatku, tým, že pošle START bit. Postupnosť NACK a STOP môže byť master zariadením zároveň využitá na signalizáciu ukončenia komunikácie v prípade operácie čítania \cite{i2cSpec}.